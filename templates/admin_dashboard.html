{% extends "admin_base.html" %}
{% block content %}

<style>
  .dashboard-container {
    width: 96%;
    margin: 30px auto;
  }

  .section {
    margin-top: 30px;
  }

  h2, h3 {
    color: #1e3a8a;
    text-align: center;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    font-size: 15px;
  }

  th, td {
    padding: 10px;
    border: 1px solid #e5e7eb;
  }

  th {
    background: #2563eb;
    color: white;
  }

  tr:nth-child(even) {
    background: #f9fafb;
  }

  .hidden {
    display: none;
  }

  .action-btn {
    padding: 6px 10px;
    border-radius: 6px;
    text-decoration: none;
    color: white;
    font-weight: 600;
    margin-right: 6px;
  }

  .approve {
    background: #16a34a;
  }

  .reject {
    background: #dc2626;
  }

  .view {
    background: #0ea5e9;
  }
</style>

<div class="dashboard-container">

  <h2>üõ† Admin Dashboard</h2>

  <!-- üî• ADMIN FLASH MESSAGE (Only for admin) -->
  {% if session.get('admin_flash') %}
      <div class="flash success" style="margin-top: 10px; text-align:center;">
          {{ session.pop('admin_flash') }}
      </div>
  {% endif %}

  <!-- Dropdown Section Selector -->
  <div style="text-align:center; margin-top: 20px;">
    <select id="sectionSelect" onchange="switchSection()"
            style="padding:10px; border-radius:6px;">
      <option value="users">üë§ Users</option>
      <option value="pending">üïí Pending Jobs</option>
      <option value="approved">‚úÖ Approved Jobs</option>
      <option value="rejected">‚ùå Rejected Jobs</option>
      <option value="support">üì© Support Messages</option>
    </select>
  </div>

  <!-- USERS -->
  <div id="users" class="section">
    <h3>üë§ Registered Users</h3>

    <table>
      <tr>
        <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Joined</th>
      </tr>

      {% for u in users %}
      <tr>
        <td>{{ u.id }}</td>
        <td>{{ u.name }}</td>
        <td>{{ u.email }}</td>
        <td>
          {% if u.is_admin %} Admin
          {% elif u.role == 'employer' %} Employer
          {% else %} Job Seeker {% endif %}
        </td>
        <td>{{ u.created_at.strftime('%Y-%m-%d') }}</td>

        <td>
          {% if not u.is_admin %}
            <a href="{{ url_for('admin_delete_user', user_id=u.id) }}"
              class="action-btn reject"
              onclick="return confirm('Delete this user and all data?')">
              Delete
            </a>
          {% else %}
            ‚Äî
        {% endif %}
      </td>
    </tr>
  {% endfor %}
    </table>
  </div>

  <!-- PENDING JOBS -->
  <div id="pending" class="section hidden">
    <h3>üïí Pending Jobs</h3>

    <table>
      <tr>
        <th>ID</th><th>Title</th><th>Poster</th><th>Status</th><th>Actions</th>
      </tr>

      {% for job in pending_jobs %}
      <tr>
        <td>{{ job.id }}</td>
        <td>{{ job.title }}</td>
        <td>{{ job.poster.email if job.poster else 'Unknown' }}</td>
        <td>{{ job.status }}</td>

        <td>
          <a href="{{ url_for('admin_view_job', job_id=job.id) }}" class="action-btn view">View</a>
          <a href="{{ url_for('approve_job', job_id=job.id) }}" class="action-btn approve">Approve</a>
          <a href="{{ url_for('reject_job', job_id=job.id) }}" class="action-btn reject">Reject</a>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="5" style="text-align:center;">No pending jobs.</td></tr>
      {% endfor %}
    </table>
  </div>

  <!-- APPROVED JOBS -->
  <div id="approved" class="section hidden">
    <h3>‚úÖ Approved Jobs</h3>

    <table>
      <tr>
        <th>ID</th><th>Title</th><th>Posted By</th><th>Date</th>
      </tr>

      {% for job in approved_jobs %}
      <tr>
        <td>{{ job.id }}</td>
        <td>{{ job.title }}</td>
        <td>{{ job.poster.email if job.poster else 'Unknown' }}</td>
        <td>{{ job.created_at.strftime('%Y-%m-%d') }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4" style="text-align:center;">No approved jobs.</td></tr>
      {% endfor %}
    </table>
  </div>

  <!-- REJECTED JOBS -->
  <div id="rejected" class="section hidden">
    <h3>‚ùå Rejected Jobs</h3>

    <table>
      <tr>
        <th>ID</th><th>Title</th><th>Posted By</th>
      </tr>

      {% for job in rejected_jobs %}
      <tr>
        <td>{{ job.id }}</td>
        <td>{{ job.title }}</td>
        <td>{{ job.poster.email if job.poster else 'Unknown' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3" style="text-align:center;">No rejected jobs.</td></tr>
      {% endfor %}
    </table>
  </div>

  <!-- SUPPORT -->
  <div id="support" class="section hidden">
    <h3>üì© Customer Support</h3>

    <table>
      <tr>
        <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Joined</th><th>Action</th>
      </tr>

      {% for msg in messages %}
      <tr>
        <td>{{ msg.id }}</td>
        <td>{{ msg.name }}</td>
        <td>{{ msg.email }}</td>
        <td>{{ msg.subject }}</td>
        <td>{{ msg.message }}</td>
        <td>{{ msg.status }}</td>

        <td>
          {% if msg.status != 'Resolved' %}
          <a href="{{ url_for('admin_support_resolve', msg_id=msg.id) }}" class="action-btn approve">Resolve</a>
          {% else %}
          <a href="{{ url_for('admin_support_delete', msg_id=msg.id) }}" onclick="return confirm('Delete permanently?')" class="action-btn reject">
            Delete
          </a>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7" style="text-align:center;">No messages found.</td></tr>
      {% endfor %}
    </table>
  </div>

</div>

<script>
function switchSection() {
    const key = document.getElementById("sectionSelect").value;
    document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
    document.getElementById(key).classList.remove("hidden");
}
</script>

{% endblock %}