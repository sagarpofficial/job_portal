{% extends "admin_base.html" %}
{% block content %}

<style>
  .dashboard-container { width:96%; margin:30px auto; }
  h2, h3 { color:#1e3a8a; text-align:center; }

  table {
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
    font-size:15px;
  }
  th, td {
    padding:10px;
    border:1px solid #e5e7eb;
    text-align:center;
  }
  th { background:#2563eb; color:white; }
  tr:nth-child(even){ background:#f9fafb; }

  .section { margin-top:30px; display:none; }

  .action-btn {
    padding:8px 14px;
    border-radius:6px;
    color:white;
    font-weight:600;
    text-decoration:none;
    display:inline-block;
  }

  .approve { background:#16a34a; }
  .reject { background:#dc2626; }
  .view { background:#0ea5e9; }

  /* Role badges */
  .badge {
    padding:4px 10px;
    border-radius:12px;
    font-size:13px;
    font-weight:600;
    color:white;
  }
  .badge-job { background:#2563eb; }
  .badge-user { background:#16a34a; }
  .badge-support { background:#7c3aed; }
  .badge-super { background:#dc2626; }
</style>

<div class="dashboard-container">

<h2>ğŸ›  Admin Dashboard</h2>

<!-- ================= SUMMARY (SUPER ADMIN ONLY) ================= -->
{% if current_admin.is_super_admin %}
<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:15px; margin-top:20px;">
  <div class="action-btn approve">ğŸ‘¤ Users<br><strong>{{ total_users }}</strong></div>
  <div class="action-btn view">ğŸ§‘â€ğŸ’¼ Employers<br><strong>{{ total_employers }}</strong></div>
  <div class="action-btn view">ğŸ§‘â€ğŸ“ Job Seekers<br><strong>{{ total_jobseekers }}</strong></div>
  <div class="action-btn approve">ğŸ“„ Jobs<br><strong>{{ total_jobs }}</strong></div>
  <div class="action-btn reject">ğŸ•’ Pending<br><strong>{{ pending_count }}</strong></div>
  <div class="action-btn approve">ğŸ“© Support<br><strong>{{ support_pending }}</strong></div>
</div>
{% endif %}

<!-- ================= SECTION SELECT ================= -->
<div style="text-align:center; margin-top:30px;">
  <select id="sectionSelect" onchange="switchSection()" style="padding:10px;">

    {% if current_admin.has_permission('manage_users') or current_admin.is_super_admin %}
      <option value="users">ğŸ‘¤ Users</option>
    {% endif %}

    {% if current_admin.is_super_admin %}
      <option value="subadmins">ğŸ›¡ Sub Admins</option>
    {% endif %}

    {% if current_admin.has_permission('manage_jobs') or current_admin.is_super_admin %}
      <option value="pending">ğŸ•’ Pending Jobs</option>
      <option value="approved">âœ… Approved Jobs</option>
      <option value="rejected">âŒ Rejected Jobs</option>
    {% endif %}

    {% if current_admin.has_permission('manage_support') or current_admin.is_super_admin %}
      <option value="support">ğŸ“© Support</option>
    {% endif %}

  </select>
</div>

<!-- ================= ACTIVITY LOG LINK ================= -->
{% if current_admin.is_super_admin or current_admin.has_permission('view_logs') %}
<div style="text-align:center; margin-top:15px;">
  <a href="{{ url_for('admin_activity') }}" class="action-btn view">
    ğŸ“œ View Admin Activity
  </a>
</div>
{% endif %}

<!-- ================= USERS ================= -->
{% if current_admin.has_permission('manage_users') or current_admin.is_super_admin %}
<div id="users" class="section">
<h3>ğŸ‘¤ Registered Users</h3>
<table>
<tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Joined</th></tr>
{% for u in users %}
<tr>
  <td>{{ u.id }}</td>
  <td>{{ u.name }}</td>
  <td>{{ u.email }}</td>
  <td>{{ u.role|title }}</td>
  <td>{{ u.created_at.strftime('%Y-%m-%d') }}</td>
</tr>
{% else %}
<tr><td colspan="5">No users found</td></tr>
{% endfor %}
</table>
</div>
{% endif %}

<!-- ================= SUB ADMINS ================= -->
{% if current_admin.is_super_admin %}
<div id="subadmins" class="section">
<h3>ğŸ›¡ Sub Admins</h3>

<div style="text-align:right; margin-bottom:10px;">
  <a href="{{ url_for('admin_create_subadmin') }}" class="action-btn view">
    â• Create Sub-Admin
  </a>
</div>

<table>
<tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Joined</th><th>Action</th></tr>

{% for a in subadmins %}
<tr>
  <td>{{ a.id }}</td>
  <td>{{ a.name }}</td>
  <td>{{ a.email }}</td>
  <td>
    {% if a.is_super_admin %}
      <span class="badge badge-super">Super Admin</span>
    {% elif a.admin_role.name == "Job Admin" %}
      <span class="badge badge-job">Job Admin</span>
    {% elif a.admin_role.name == "User Admin" %}
      <span class="badge badge-user">User Admin</span>
    {% elif a.admin_role.name == "Support Admin" %}
      <span class="badge badge-support">Support Admin</span>
    {% endif %}
  </td>
  <td>{{ a.created_at.strftime('%Y-%m-%d') }}</td>
  <td>
    <a href="{{ url_for('admin_delete_subadmin', user_id=a.id) }}"
       class="action-btn reject"
       onclick="return confirm('Delete this sub-admin?')">
       ğŸ—‘ Delete
    </a>
  </td>
</tr>
{% else %}
<tr><td colspan="6">No sub-admins found</td></tr>
{% endfor %}
</table>
</div>
{% endif %}

<!-- ================= JOBS ================= -->
{% if current_admin.has_permission('manage_jobs') or current_admin.is_super_admin %}

<div id="pending" class="section">
<h3>ğŸ•’ Pending Jobs</h3>
<table>
<tr><th>ID</th><th>Title</th><th>Posted By</th><th>Action</th></tr>
{% for job in pending_jobs %}
<tr>
<td>{{ job.id }}</td>
<td>{{ job.title }}</td>
<td>{{ job.poster.email }}</td>
<td>
<a href="{{ url_for('admin_view_job', job_id=job.id) }}" class="action-btn view">View</a>
<a href="{{ url_for('approve_job', job_id=job.id) }}" class="action-btn approve">Approve</a>
<a href="{{ url_for('reject_job', job_id=job.id) }}" class="action-btn reject">Reject</a>
</td>
</tr>
{% else %}
<tr><td colspan="4">No pending jobs</td></tr>
{% endfor %}
</table>
</div>

<div id="approved" class="section">
<h3>âœ… Approved Jobs</h3>
<table>
<tr><th>ID</th><th>Title</th><th>Posted By</th><th>Date</th></tr>
{% for job in approved_jobs %}
<tr>
<td>{{ job.id }}</td>
<td>{{ job.title }}</td>
<td>{{ job.poster.email }}</td>
<td>{{ job.created_at.strftime('%Y-%m-%d') }}</td>
</tr>
{% else %}
<tr><td colspan="4">No approved jobs</td></tr>
{% endfor %}
</table>
</div>

<div id="rejected" class="section">
<h3>âŒ Rejected Jobs</h3>
<table>
<tr><th>ID</th><th>Title</th><th>Posted By</th></tr>
{% for job in rejected_jobs %}
<tr>
<td>{{ job.id }}</td>
<td>{{ job.title }}</td>
<td>{{ job.poster.email }}</td>
</tr>
{% else %}
<tr><td colspan="3">No rejected jobs</td></tr>
{% endfor %}
</table>
</div>

{% endif %}

<!-- ================= SUPPORT ================= -->
{% if current_admin.has_permission('manage_support') or current_admin.is_super_admin %}
<div id="support" class="section">
<h3>ğŸ“© Support Messages</h3>
<table>
<tr><th>Name</th><th>Email</th><th>Message</th><th>Status</th></tr>
{% for msg in messages %}
<tr>
<td>{{ msg.name }}</td>
<td>{{ msg.email }}</td>
<td>{{ msg.message }}</td>
<td>{{ msg.status }}</td>
</tr>
{% else %}
<tr><td colspan="4">No messages</td></tr>
{% endfor %}
</table>
</div>
{% endif %}

</div>

<script>
function switchSection(){
  const select = document.getElementById("sectionSelect");
  if(!select) return;

  const value = select.value;
  document.querySelectorAll(".section").forEach(s => s.style.display="none");

  const active = document.getElementById(value);
  if(active) active.style.display="block";
}

window.onload = switchSection;
</script>

{% endblock %}